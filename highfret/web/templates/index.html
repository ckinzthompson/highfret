<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>highFRET</title>
	<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
	<style>
		body {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			min-height: 100vh;
			padding: 20px 0;
		}
		.main-container {
			max-width: 900px;
			margin: 0 auto;
		}
		.card {
			border: none;
			box-shadow: 0 10px 40px rgba(0,0,0,0.2);
			border-radius: 15px;
		}
		.btn-primary {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			border: none;
			padding: 10px 30px;
			font-weight: 500;
			margin-right: 10px;
			margin-bottom: 10px;
		}
		.btn-primary:hover {
			transform: translateY(-2px);
			box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
		}
		.btn-secondary {
			padding: 10px 20px;
		}
		.result-box {
			background: #f8f9fa;
			border-radius: 8px;
			padding: 15px;
			margin-top: 20px;
			min-height: 100px;
			white-space: pre-wrap;
			font-family: 'Courier New', monospace;
		}
		.images-container {
			margin-top: 20px;
			padding: 15px;
			background: #ffffff;
			border-radius: 8px;
			border: 2px solid #e9ecef;
		}
		.image-grid {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
			gap: 20px;
			margin-top: 15px;
		}
		.image-item {
			border: 1px solid #dee2e6;
			border-radius: 8px;
			overflow: hidden;
			background: white;
			box-shadow: 0 2px 8px rgba(0,0,0,0.1);
			transition: transform 0.2s;
		}
		.image-item:hover {
			transform: translateY(-4px);
			box-shadow: 0 4px 12px rgba(0,0,0,0.15);
		}
		.image-item img {
			width: 100%;
			height: 250px;
			object-fit: contain;
			background: #f8f9fa;
			padding: 10px;
		}
		.image-item .image-name {
			padding: 10px;
			background: #f8f9fa;
			font-size: 0.9em;
			text-align: center;
			border-top: 1px solid #dee2e6;
			word-break: break-all;
		}
		.pdf-indicator {
			display: flex;
			align-items: center;
			justify-content: center;
			height: 250px;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			font-size: 3em;
		}
		.open-folder-btn {
			margin-top: 10px;
		}
		.spinner-border {
			width: 1.5rem;
			height: 1.5rem;
		}
		.input-group {
			box-shadow: 0 2px 8px rgba(0,0,0,0.1);
			border-radius: 8px;
			overflow: hidden;
		}
		.button-group {
			margin-top: 20px;
		}
		.parameters-section {
			background: #f8f9fa;
			padding: 20px;
			border-radius: 8px;
			margin-top: 20px;
		}
		.param-row {
			margin-bottom: 15px;
		}
	</style>
</head>
<body>
	<div class="main-container">
		<div class="card">
			<div class="card-header bg-white py-4">
				<h2 class="text-center mb-0">highFRET</h2>
			</div>
			<div class="card-body p-4">
				<div class="mb-3">
					<label class="form-label fw-bold">Movie File (.tif):</label>
					<div class="input-group">
						<input type="text" class="form-control" id="filename" placeholder="Enter file path or browse...">
						<button class="btn btn-secondary" type="button" onclick="browseFile('filename')">
							Browse
						</button>
					</div>
					<small class="form-text text-muted">Enter the path to your movie file</small>
				</div>

				<div class="button-group">
					<button class="btn btn-primary" onclick="runMethod('refresh')">
						<span id="spinner1" class="spinner-border spinner-border-sm me-2 d-none"></span>
						Refresh
					</button>
					<button class="btn btn-primary" onclick="runMethod('new')">
						<span id="spinner2" class="spinner-border spinner-border-sm me-2 d-none"></span>
						New
					</button>
					<button class="btn btn-primary" onclick="runMethod('intensity')">
						<span id="spinner3" class="spinner-border spinner-border-sm me-2 d-none"></span>
						Pixel Intensity
					</button>
					<br>
					<button class="btn btn-primary" onclick="runMethod('align')">
						<span id="spinner4" class="spinner-border spinner-border-sm me-2 d-none"></span>
						Align
					</button>
					
					<button class="btn btn-primary" onclick="runMethod('spotfind')">
						<span id="spinner5" class="spinner-border spinner-border-sm me-2 d-none"></span>
						Spotfind
					</button>
					<button class="btn btn-primary" onclick="runMethod('optimizepsf')">
						<span id="spinner7" class="spinner-border spinner-border-sm me-2 d-none"></span>
						Check PSF
					</button>
					<button class="btn btn-primary" onclick="runMethod('extract')">
						<span id="spinner6" class="spinner-border spinner-border-sm me-2 d-none"></span>
						Extract
					</button>
					<!-- <button class="btn btn-primary" onclick="runMethod('auto')">
						<span id="spinner8" class="spinner-border spinner-border-sm me-2 d-none"></span>
						Auto
					</button> -->
				</div>

				<div id="result" class="result-box d-none"></div>
				<div id="images" class="images-container d-none">
					<h5>Output Figures:</h5>
					<div id="images-grid" class="image-grid"></div>
				</div>

								<!-- Parameters Section - Collapsible -->
				<div class="parameters-section">
					<div class="d-flex justify-content-between align-items-center mb-3">
						<h5 class="mb-0">Parameters</h5>
						<button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#parametersCollapse" aria-expanded="false">
							<span class="when-open" style="display:none;">â–¼ Hide</span>
							<span class="when-closed">â–¶ Show</span>
						</button>
					</div>
					
					<div class="collapse" id="parametersCollapse">
						<!-- Integer Parameter -->
						<div class="param-row">
							<label for="start" class="form-label">Start (integer):</label>
							<input type="number" class="form-control" id="start" value="0" step="1" min="0">
							<small class="form-text text-muted">Start analysis on this frame. Use to ignore sections of a movie</small>
						</div>

						<div class="param-row">
							<label for="bin" class="form-label">Bin (integer):</label>
							<input type="number" class="form-control" id="bin" value="1" step="1" min="1">
							<small class="form-text text-muted">Bin the movie by adding X neighboring pixels together. Can speed up calculations; useful for low memory. Only works with New button </small>
						</div>

						<!-- Float Parameter -->
						<div class="param-row">
							<label for="sigma" class="form-label">Sigma (float):</label>
							<input type="number" class="form-control" id="sigma" value="0.5" step="0.01" min="0.01" max="10.">
							<small class="form-text text-muted">PSF width for extracting intensity</small>
						</div>

						<div class="param-row">
							<label for="cutoff" class="form-label">Spot Cutoff (float):</label>
							<input type="number" class="form-control" id="cutoff" value="0.15" step="0.01" min="0.01" max="0.99">
							<small class="form-text text-muted">ACF value threshold to define a local maximum as a spot</small>
						</div>

						<!-- Dropdown/Combobox -->
						<div class="param-row">
							<label for="split" class="form-label">Color Split:</label>
							<select class="form-select" id="split">
								<option value="none">None</option>
								<option value="lr" selected>L/R</option>
								<option value="tb">T/B</option>
								<option value="quad">Quad</option>
							</select>
							<small class="form-text text-muted">How to divide the color channels of the movie</small>
						</div>

						<div class="param-row">
							<label for="which" class="form-label">Spots Channel:</label>
							<select class="form-select" id="which">
								<option value="all" selected>Both</option>
								<option value="green">Green</option>
								<option value="red">Red</option>
							</select>
							<small class="form-text text-muted">Only keep spots from this color channel</small>
						</div>

						<div class="param-row">
							<label for="fast" class="form-label">Extraction Mode:</label>
							<select class="form-select" id="fast">
								<option value="true">Fast</option>
								<option value="false" selected>MLE iterations</option>
							</select>
							<small class="form-text text-muted">Select processing algorithm for estimating spot intensity</small>
						</div>

						<div class="param-row">
							<label for="second" class="form-label">Second Order Alignment:</label>
							<select class="form-select" id="second">
								<option value="true" selected>True</option>
								<option value="false">False</option>
							</select>
							<small class="form-text text-muted">Perform alignment to second order polynomial (slower), or just stop at first (faster)</small>
						</div>
					</div>
				</div>

			</div>
		</div>
	</div>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
	<script>
		// Toggle button text when collapse opens/closes
		const collapseElement = document.getElementById('parametersCollapse');
		collapseElement.addEventListener('show.bs.collapse', function () {
			document.querySelector('.when-open').style.display = 'inline';
			document.querySelector('.when-closed').style.display = 'none';
		});
		collapseElement.addEventListener('hide.bs.collapse', function () {
			document.querySelector('.when-open').style.display = 'none';
			document.querySelector('.when-closed').style.display = 'inline';
		});

		async function browseFile(inputId) {
			try {
				// Use PyWebView's native file dialog
				const filepath = await pywebview.api.select_file();
				if (filepath) {
					document.getElementById(inputId).value = filepath;
				}
			} catch (error) {
				console.error('File selection error:', error);
				alert('Error selecting file. Make sure you are running this in PyWebView.');
			}
		}

		async function runMethod(method) {
			const filename = document.getElementById('filename').value;
			
			const resultDiv = document.getElementById('result');
			const imagesDiv = document.getElementById('images');
			const imagesGrid = document.getElementById('images-grid');

			const param_start = parseInt(document.getElementById('start').value);
			const param_bin = parseInt(document.getElementById('bin').value);
			const param_sigma = parseFloat(document.getElementById('sigma').value);
			const param_cutoff = parseFloat(document.getElementById('cutoff').value);
			const param_split = document.getElementById('split').value;
			const param_which = document.getElementById('which').value;
			const param_fast = document.getElementById('fast').value;
			const param_second = document.getElementById('second').value;
			
			const params = {
				start: param_start,
				bin: param_bin,
				sigma: param_sigma,
				cutoff: param_cutoff,
				split: param_split,
				which: param_which,
				fast: param_fast,
				second: param_second,
			};

			// Map methods to their spinner IDs
			const spinnerMap = {
				'refresh': 'spinner1',
				'new': 'spinner2',
				'intensity': 'spinner3',
				'align': 'spinner4',
				'spotfind': 'spinner5',
				'extract': 'spinner6',
				'optimizepsf': 'spinner7',
				'auto': 'spinner8'
			};
			
			const spinner = document.getElementById(spinnerMap[method]);
			
			if (!filename) {
				resultDiv.classList.remove('d-none');
				resultDiv.innerHTML = '<span class="text-danger">Error: Please enter a filename</span>';
				return;
			}

			// Show spinner, hide previous results
			if (spinner) spinner.classList.remove('d-none');
			resultDiv.classList.add('d-none');
			imagesDiv.classList.add('d-none');
			imagesGrid.innerHTML = '';

			try {
				const response = await fetch('/run_method', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({
						method: method,
						filename: filename,
						params: params
					})
				});

				const data = await response.json();
				
				// Hide spinner
				if (spinner) spinner.classList.add('d-none');
				resultDiv.classList.remove('d-none');

				if (data.success) {
					resultDiv.innerHTML = `<span class="text-success fw-bold">Success!</span>\n\n${data.result}`;
					
					// Display images if any were generated
					if (data.images && data.images.length > 0) {
						imagesDiv.classList.remove('d-none');
						
						// Clear any existing folder button
						const existingBtn = imagesDiv.querySelector('.open-folder-btn');
						if (existingBtn) existingBtn.remove();
						
						// Add button to open output folder
						if (data.output_folder) {
							const openFolderBtn = document.createElement('button');
							openFolderBtn.className = 'btn btn-sm btn-secondary open-folder-btn';
							openFolderBtn.textContent = 'Open Output Folder';
							openFolderBtn.onclick = () => openFolder(data.output_folder);
							imagesDiv.insertBefore(openFolderBtn, imagesGrid);
						}
						
						// Display each image pair
						data.images.forEach(item => {
							const imageItem = document.createElement('div');
							imageItem.className = 'image-item';
							imageItem.style.cursor = 'pointer';
							
							// Determine what to open when clicked
							const fileToOpen = item.pdf || item.png;
							
							if (item.png) {
								// Show PNG thumbnail
								const cacheBuster = new Date().getTime();
								imageItem.innerHTML = `
									<img src="/get_image${item.png}?t=${cacheBuster}" alt="${item.name}">
									<div class="image-name">${item.name}${item.pdf ? ' (PDF)' : ''}</div>
								`;
							} else {
								// PDF without thumbnail - show icon
								imageItem.innerHTML = `
									<div class="pdf-indicator">ðŸ“„</div>
									<div class="image-name">${item.name}</div>
								`;
							}
							
							imageItem.onclick = () => openFile(fileToOpen);
							imagesGrid.appendChild(imageItem);
						});
					}
				} else {
					resultDiv.innerHTML = `<span class="text-danger fw-bold">Error:</span>\n\n${data.error}`;
				}
			} catch (error) {
				if (spinner) spinner.classList.add('d-none');
				resultDiv.classList.remove('d-none');
				resultDiv.innerHTML = `<span class="text-danger fw-bold">Error:</span>\n\n${error.message}`;
			}
		}

		async function openFile(filepath) {
			try {
				await pywebview.api.open_file(filepath);
			} catch (error) {
				console.error('Error opening file:', error);
			}
		}

		async function openFolder(folderpath) {
			try {
				await pywebview.api.open_folder(folderpath);
			} catch (error) {
				console.error('Error opening folder:', error);
			}
		}
	</script>
</body>
</html>